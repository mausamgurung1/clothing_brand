{% extends 'layout.html' %}
{% load static %}

{% block title %}Baabuu Clothing - Checkout{% endblock %}

{% block body %}

<div class="wraper">
    <div class="page-content-wraper">
        <!-- Bread Crumb -->
        <section class="breadcrumb">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <nav class="breadcrumb-link">
                            <a href="{% url 'home' %}">Home</a>
                            <a href="{% url 'cart' %}">Cart</a>
                            <span>Checkout</span>
                        </nav>
                    </div>
                </div>
            </div>
        </section>

        <!-- Page Content -->
        <section class="content-page">
            <div class="container mb-80">
                <div class="row">
                    <div class="col-sm-12">
                        <article class="post-8">
                            <div class="row">
                                <div class="col-md-6">
                                    <h3>Billing details</h3>
                                    <form id="addressForm" class="product-checkout mt-45" method='POST'
                                          action="/address/">
                                        {% csrf_token %}
                                        <div class="row">
                                            <div class="form-field-wrapper form-center col-sm-6">
                                                <label for="billing_first_name" class="left">
                                                    First Name <abbr class="form-required" title="required">*</abbr>
                                                </label>
                                                <input class="input-md form-full-width" name="first_name"
                                                       value="{{ firstname }}" placeholder="First Name" type="text"
                                                       required>
                                            </div>
                                            <div class="form-field-wrapper form-center col-sm-6">
                                                <label for="billing_last_name" class="left">
                                                    Last Name <abbr class="form-required" title="required">*</abbr>
                                                </label>
                                                <input class="input-md form-full-width" name="last_name"
                                                       value="{{ lastname }}" placeholder="Last Name" type="text"
                                                       required>
                                            </div>
                                            <div class="form-field-wrapper form-center col-sm-12">
                                                <label for="billing_address" class="left">
                                                    Address <abbr class="form-required" title="required">*</abbr>
                                                </label>
                                                <input class="input-md form-full-width mb-20" name="address"
                                                       value="{{ user_address.street_address }}"
                                                       placeholder="Street Address" type="text" required>
                                            </div>
                                            <div class="form-field-wrapper form-center col-sm-12">
                                                <label for="billing_town_city" class="left">
                                                    Town / City <abbr class="form-required" title="required">*</abbr>
                                                </label>
                                                <input class="input-md form-full-width" name="city"
                                                       value="{{ user_address.city }}" placeholder="" type="text"
                                                       required>
                                            </div>
                                            <div class="form-field-wrapper form-center col-sm-12">
                                                <label for="billing_country" class="left">
                                                    County <abbr class="form-required" title="required">*</abbr>
                                                </label>
                                                <select name="country" id="billing_country"
                                                        class="input-md form-full-width" required>
                                                    <option value="india" selected="selected">India</option>
                                                </select>
                                            </div>
                                            <div class="form-field-wrapper form-center col-sm-12">
                                                <label for="billing_state" class="left">
                                                    State <abbr class="form-required" title="required">*</abbr>
                                                </label>
                                                <select name="state" id="state" class="input-md form-full-width"
                                                        required>
                                                    {% if user_address.state %}
                                                        <option value="{{ user_address.state.pk }}"
                                                                selected>{{ user_address.state.state_name }}</option>
                                                    {% else %}
                                                        <option value="" selected disabled>Select a state</option>
                                                    {% endif %}
                                                    {% for states in state %}
                                                        <option value="{{ states.pk }}">{{ states.state_name}}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-field-wrapper form-center col-sm-12">
                                                <label for="billing_postcode" class="left">
                                                    Postcode / ZIP <abbr class="form-required" title="required">*</abbr>
                                                </label>
                                                <input class="input-md form-full-width" name="pincode"
                                                       value="{{ user_address.pincode }}" placeholder="" type="text"
                                                       required>
                                            </div>
                                            <div class="form-field-wrapper form-center col-sm-6">
                                                <label for="billing_phone" class="left">
                                                    Phone <abbr class="form-required" title="required">*</abbr>
                                                </label>
                                                <input class="input-md form-full-width" name="phone"
                                                       value="{{ user_address.phone_number }}"
                                                       placeholder="(+00) 123 456 7890" type="tel" required>
                                            </div>
                                            <div class="form-field-wrapper form-center col-sm-6">
                                                <label for="billing_email" class="left">
                                                    Email <abbr class="form-required" title="required">*</abbr>
                                                </label>
                                                <input class="input-md form-full-width" name="email"
                                                       value="{{ user.user_email }}" placeholder="Enter Email"
                                                       type="email" required>
                                            </div>
                                            <button type="submit" class="btn btn-lg btn-color form-full-width">Save
                                                Address
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <div class="col-md-6">
                                    <div class="checkout-order-review">
                                        <h3>Your order</h3>
                                        <div class="product-checkout-review-order">
                                            <div class="responsive-table">
                                                <table>
                                                    <thead>
                                                    <tr>
                                                        <th class="product-name">Product</th>
                                                        <th class="product-total">Total</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for item in users %}
                                                        <tr class="cart_item">
                                                            <td class="product-name">{{ item.subproduct.product.name }}
                                                                - {{ item.color }} {{ item.size }}<strong>
                                                                    x {{ item.quantity }}</strong></td>
                                                            <td class="product-total">
                                                                <span class="product-price-amount amount">
                                                                    {% if 'USD' in request.session.currency %}
                                                                        $ {{ item.total_price_usd|floatformat:2 }}
                                                                    {% else %}
                                                                        Rs {{ item.total_price|floatformat:2 }}
                                                                    {% endif %}
                                                                </span>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                    </tbody>
                                                    <tfoot>
                                                    <tr class="cart-subtotal">
                                                        <th>Subtotal</th>
                                                        <td>
                                                            <strong><span class="product-price-amount amount">
                                                                    {% if 'USD' in request.session.currency %}
                                                                        ${{ total_cart_price_usd|floatformat:2 }}
                                                                    {% else %}
                                                                        Rs{{ total_cart_price|floatformat:2 }}
                                                                    {% endif %}
                                                                </span></strong>
                                                        </td>
                                                    </tr>
                                                    <tr class="shipping">
                                                        <th>Shipping</th>
                                                        <td>
                                                                <span class="woocommerce-Price-amount amount">
                                                                    {% if 'USD' in request.session.currency %}
                                                                        ${{ shipping_price_usd|floatformat:2 }}
                                                                    {% else %}
                                                                        Rs{{ shipping_price|floatformat:2 }}
                                                                    {% endif %}
                                                                </span>
                                                        </td>
                                                    </tr>
                                                    <tr class="order-total">
                                                        <th>Total</th>
                                                        <td>
                                                            <strong><span class="product-price-amount amount"
                                                                          id="final-total">
                                                                    {% if 'USD' in request.session.currency %}
                                                                        ${{ after_shipping_price_usd|floatformat:2 }}
                                                                    {% else %}
                                                                        Rs{{ after_shipping_price|floatformat:2 }}
                                                                    {% endif %}
                                                                </span></strong>
                                                        </td>
                                                    </tr>
                                                    </tfoot>
                                                </table>
                                            </div>

                                            <div class="product-checkout-payment">
                                                <h4 style="margin-bottom: 15px;">Select Payment Method</h4>

                                                <!-- Payment Method Options -->
                                                <div class="payment-methods">
                                                    <label class="payment-option">
                                                        <input type="radio" name="payment_method" value="paypal"
                                                               checked/>
                                                        <span class="payment-label">
                                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                                                 xmlns="http://www.w3.org/2000/svg">
                                                                <path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944 3.47a.77.77 0 0 1 .76-.633h7.2c2.325 0 3.96.48 4.865 1.425.88.92 1.245 2.28.96 3.945-.015.09-.03.18-.06.27-.48 3.015-1.95 4.8-4.14 5.04v.03c.93.15 1.62.48 2.055.975.435.48.66 1.155.66 2.01 0 .27-.03.555-.075.855-.105.63-.3 1.245-.585 1.845a5.67 5.67 0 0 1-1.155 1.56c-.495.45-1.095.81-1.785 1.065-.69.255-1.5.39-2.415.39H7.076zm3.33-8.91c.165 0 .315-.015.45-.045.72-.12 1.275-.48 1.665-1.065.39-.585.66-1.38.81-2.37.03-.18.045-.345.045-.495 0-.48-.12-.825-.36-1.05-.24-.225-.66-.345-1.245-.345H9.546l-.9 5.37h1.71zm-2.25 6.45h1.8c.195 0 .39-.015.57-.045.72-.105 1.29-.39 1.71-.87.42-.48.72-1.17.9-2.07.03-.165.045-.33.045-.48 0-.555-.15-.975-.45-1.26-.3-.285-.795-.435-1.485-.435H9.606l-.9 5.16z"
                                                                      fill="#003087"/>
                                                                <path d="M18.446 3.47c.72 1.635.405 3.735-.945 6.015-1.065 1.785-2.58 2.97-4.485 3.465l-.915 5.04H2.47a.641.641 0 0 1-.633-.74L4.944 3.47a.77.77 0 0 1 .76-.633h12.742z"
                                                                      fill="#0070E0"/>
                                                            </svg>
                                                            PayPal
                                                        </span>
                                                    </label>

                                                    <label class="payment-option">
                                                        <input type="radio" name="payment_method" value="stripe"/>
                                                        <span class="payment-label">
                                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                                                 xmlns="http://www.w3.org/2000/svg">
                                                                <rect width="24" height="24" rx="4" fill="#6772E5"/>
                                                                <path d="M11.9 6.6c-1.4 0-2.3.6-2.3 1.6 0 .8.6 1.3 1.7 1.6l.6.2c.7.2 1 .5 1 .9 0 .5-.5.8-1.3.8-.9 0-1.6-.3-2.1-.6l-.4 1.5c.6.3 1.4.6 2.4.6 1.6 0 2.6-.7 2.6-1.8 0-.8-.6-1.4-1.8-1.7l-.6-.2c-.6-.2-.9-.4-.9-.8 0-.4.4-.7 1.1-.7.7 0 1.3.2 1.7.4l.4-1.5c-.5-.2-1.2-.4-2.1-.4zm-5.5.1L4 13.3h1.9l.4-1.9h2.2l.2.9c.1.5.1.7.1.9h1.9l-1.3-6.6H6.4zm1.5 1.7l.7 3.1h-1.5l.8-3.1zm8.8-1.7l-1.4 6.6h1.8l1.4-6.6h-1.8z"
                                                                      fill="white"/>
                                                            </svg>
                                                            Credit/Debit Card
                                                        </span>
                                                    </label>

                                                    <label class="payment-option">
                                                        <input type="radio" name="payment_method" value="cod"/>
                                                        <span class="payment-label">
                                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                                                 xmlns="http://www.w3.org/2000/svg">
                                                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1.86.92 1.63 2.31 1.63 1.55 0 2.04-.86 2.04-1.51 0-.93-.61-1.44-2.66-1.85-2.33-.47-4.11-1.56-4.11-3.44 0-1.78 1.43-2.72 3.12-3.16V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-1.9-1.87-1.39 0-2.19.87-2.19 1.64 0 .86.7 1.42 2.78 1.87 2.41.49 3.99 1.61 3.99 3.72 0 1.55-1.15 2.49-2.57 2.95z"
                                                                      fill="#2E7D32"/>
                                                            </svg>
                                                            Cash on Delivery
                                                        </span>
                                                    </label>
                                                </div>

                                                <!-- Stripe Payment Form -->
                                                <div id="stripe-payment" class="payment-section" style="display:none;">
                                                    <div id="card-element"></div>
                                                    <div id="card-errors" role="alert"></div>
                                                </div>

                                                <!-- PayPal Button -->
                                                <div id="paypal-payment" class="payment-section">
                                                    <div id="paypal-button-container"></div>
                                                </div>

                                                <!-- COD Info -->
                                                <div id="cod-payment" class="payment-section" style="display:none;">
                                                    <p style="padding: 15px; background: #f5f5f5; border-radius: 4px; margin: 15px 0;">
                                                        ðŸ’µ Pay with cash when your order is delivered to your doorstep.
                                                    </p>
                                                </div>

                                                <div class="place-order" id="place-order-container"
                                                     style="display:none;">
                                                    <button id="place-order-btn"
                                                            class="btn btn-lg btn-color form-full-width">Place Order
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </article>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>
<!-- Load Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<!-- Load PayPal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id={{ PAYPAL_CLIENT_ID }}&currency=USD"></script>

<!-- SweetAlert2 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // CRITICAL FIX: Define paypalTotalUSD properly
    const paypalTotalUSD = parseFloat({{ after_shipping_price_usd|default:"0" }});
    console.log('PayPal Total USD:', paypalTotalUSD);
    
    // Validate the amount
    if (!paypalTotalUSD || paypalTotalUSD <= 0) {
        console.error('Invalid PayPal amount detected!');
    }
</script>

<script>
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // Initialize Stripe
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements();
    const cardElement = elements.create('card', {
        style: {
            base: {
                fontSize: '16px',
                color: '#32325d',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                '::placeholder': {
                    color: '#aab7c4'
                }
            },
            invalid: {
                color: '#fa755a',
                iconColor: '#fa755a'
            }
        }
    });
    cardElement.mount('#card-element');

    cardElement.on('change', (event) => {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
            displayError.style.display = 'block';
        } else {
            displayError.textContent = '';
            displayError.style.display = 'none';
        }
    });

    // Simplified PayPal Integration - Less Strict
paypal.Buttons({
    createOrder: function (data, actions) {
        console.log('=== PayPal Order Creation Started ===');
        console.log('Amount:', paypalTotalUSD);
        
        // Validation
        if (!validateAddressForm()) {
            console.error('Validation failed: Address incomplete');
            Swal.fire('Error', 'Please fill in all required billing details', 'warning');
            return actions.reject();
        }

        if (!paypalTotalUSD || paypalTotalUSD <= 0) {
            console.error('Validation failed: Invalid amount');
            Swal.fire('Error', 'Invalid order amount', 'error');
            return actions.reject();
        }

        // SIMPLIFIED: Just the essential fields
        return actions.order.create({
            purchase_units: [{
                amount: {
                    currency_code: 'USD',
                    value: paypalTotalUSD.toFixed(2)
                }
            }]
        }).then(function(orderId) {
            console.log('âœ“ PayPal order created:', orderId);
            return orderId;
        }).catch(function(error) {
            console.error('âœ— PayPal order creation failed:', error);
            
            // Show user-friendly error
            Swal.fire({
                icon: 'error',
                title: 'Cannot Create Order',
                html: `
                    <p><strong>PayPal is having trouble processing your request.</strong></p>
                    <p>This usually happens when:</p>
                    <ul style="text-align: left; margin: 15px auto; max-width: 400px;">
                        <li>Sandbox account needs funds reset</li>
                        <li>Browser is blocking PayPal</li>
                        <li>Currency conversion issues</li>
                    </ul>
                    <p><strong>Quick fixes:</strong></p>
                    <ol style="text-align: left; margin: 15px auto; max-width: 400px;">
                        <li>Try refreshing the page</li>
                        <li>Clear browser cache</li>
                        <li>Use Credit Card payment instead</li>
                    </ol>
                `,
                confirmButtonText: 'Try Again'
            });
            
            throw error;
        });
    },
    
    onApprove: function (data, actions) {
        console.log('=== PayPal Payment Approved ===');
        console.log('Capturing order:', data.orderID);
        
        // Show loading state
        Swal.fire({
            title: 'Processing Payment...',
            html: 'Please wait while we confirm your PayPal payment.<br><small>Do not close this window.</small>',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        return actions.order.capture().then(function (details) {
            console.log('âœ“ Payment captured:', details);
            console.log('Payer:', details.payer.name.given_name);
            console.log('Status:', details.status);
            
            return handlePayPalSuccess(data.orderID, details);
        }).catch(function(error) {
            console.error('âœ— Payment capture failed:', error);
            Swal.fire({
                icon: 'error',
                title: 'Capture Failed',
                text: 'Could not capture your payment. Please contact support.',
                footer: 'Order ID: ' + data.orderID
            });
        });
    },
    
    onError: function (err) {
        console.error('=== PayPal Error ===');
        console.error('Error details:', err);
        
        // More helpful error message
        Swal.fire({
            icon: 'error',
            title: 'PayPal Error',
            html: `
                <p><strong>Unfortunately, PayPal encountered an error.</strong></p>
                <p style="color: #666; font-size: 14px;">This is often due to sandbox account limitations.</p>
                <hr style="margin: 15px 0;">
                <p><strong>Recommended solutions:</strong></p>
                <div style="text-align: left; margin: 15px auto; max-width: 400px;">
                    <p>1. <strong>For testing:</strong> Reset your PayPal sandbox account balance</p>
                    <p>2. <strong>Alternative:</strong> Use the Credit Card payment option</p>
                    <p>3. <strong>Or:</strong> Try Cash on Delivery</p>
                </div>
            `,
            confirmButtonText: 'Choose Another Method',
            showCancelButton: true,
            cancelButtonText: 'Try PayPal Again'
        });
    },
    
    onCancel: function (data) {
        console.log('=== PayPal Cancelled ===');
        Swal.fire({
            icon: 'info',
            title: 'Payment Cancelled',
            text: 'You cancelled the PayPal payment. Your cart is still saved.',
            confirmButtonText: 'OK'
        });
    },
    
    style: {
        layout: 'vertical',
        color: 'gold',
        shape: 'rect',
        label: 'paypal'
    }
}).render('#paypal-button-container');

// PayPal Success Handler
async function handlePayPalSuccess(orderID, details) {
    console.log('=== Processing Order on Server ===');
    
    try {
        // Step 1: Save to session
        console.log('Step 1: Saving order to session...');
        const createResponse = await fetch('/create-paypal-order/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ orderID: orderID })
        });

        const createResult = await createResponse.json();
        console.log('Session save result:', createResult);

        if (!createResult.success) {
            throw new Error(createResult.error || 'Failed to save order');
        }

        // Step 2: Capture and create database order
        console.log('Step 2: Creating database order...');
        const captureResponse = await fetch('/capture-paypal-order/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ orderID: orderID })
        });

        if (!captureResponse.ok) {
            const errorText = await captureResponse.text();
            console.error('Server error:', errorText);
            throw new Error('Server error: ' + captureResponse.status);
        }

        const result = await captureResponse.json();
        console.log('Capture result:', result);

        if (result.success) {
            console.log('âœ“ Order completed successfully!');
            
            Swal.fire({
                icon: 'success',
                title: 'Order Placed Successfully!',
                html: `
                    <p><strong>Thank you for your purchase!</strong></p>
                    <p>Order Number: <strong>#${result.order_id}</strong></p>
                    <p>A confirmation email has been sent to you.</p>
                `,
                confirmButtonText: 'View My Orders',
                timer: 5000
            }).then(() => {
                window.location.href = '/order_history/';
            });
        } else {
            throw new Error(result.error || 'Unknown error');
        }
    } catch (err) {
        console.error('âœ— Processing failed:', err);
        
        Swal.fire({
            icon: 'error',
            title: 'Order Processing Failed',
            html: `
                <p><strong>Your payment was received by PayPal, but we couldn't complete the order.</strong></p>
                <p style="color: #e74c3c;">Error: ${err.message}</p>
                <hr>
                <p>Please contact support with this information:</p>
                <p style="font-family: monospace; background: #f5f5f5; padding: 10px;">
                    Order ID: ${orderID}<br>
                    Time: ${new Date().toLocaleString()}
                </p>
            `,
            confirmButtonText: 'Contact Support',
            footer: 'Don\'t worry - your payment is secure and can be refunded if needed.'
        });
    }
}
    // Payment method toggle
    document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
        radio.addEventListener('change', function () {
            console.log('Payment method changed to:', this.value);
            
            // Hide all payment sections
            document.getElementById('stripe-payment').style.display = 'none';
            document.getElementById('paypal-payment').style.display = 'none';
            document.getElementById('cod-payment').style.display = 'none';
            document.getElementById('place-order-container').style.display = 'none';

            // Show selected payment section
            if (this.value === 'stripe') {
                document.getElementById('stripe-payment').style.display = 'block';
                document.getElementById('place-order-container').style.display = 'block';
            } else if (this.value === 'paypal') {
                document.getElementById('paypal-payment').style.display = 'block';
            } else if (this.value === 'cod') {
                document.getElementById('cod-payment').style.display = 'block';
                document.getElementById('place-order-container').style.display = 'block';
            }
        });
    });

    // Place Order Button (for Stripe and COD)
    document.getElementById('place-order-btn').addEventListener('click', async function (e) {
        e.preventDefault();
        console.log('Place order button clicked');

        if (!validateAddressForm()) {
            Swal.fire('Error', 'Please fill in all required billing details', 'warning');
            return;
        }

        const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
        console.log('Selected payment method:', paymentMethod);

        if (paymentMethod === 'cod') {
            handleCOD();
        } else if (paymentMethod === 'stripe') {
            handleStripePayment();
        }
    });

    // Stripe Payment Handler
    async function handleStripePayment() {
        console.log('Processing Stripe payment...');
        
        Swal.fire({
            title: 'Processing...',
            text: 'Please wait while we process your payment',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        try {
            const response = await fetch('/create-stripe-payment-intent/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            });

            const data = await response.json();

            if (data.error) {
                Swal.fire('Error', data.error, 'error');
                return;
            }

            const {error, paymentIntent} = await stripe.confirmCardPayment(data.clientSecret, {
                payment_method: {
                    card: cardElement
                }
            });

            if (error) {
                console.error('Stripe error:', error);
                Swal.fire('Payment Failed', error.message, 'error');
            } else if (paymentIntent.status === 'succeeded') {
                console.log('Stripe payment succeeded');
                handleStripeSuccess(paymentIntent.id);
            }
        } catch (err) {
            console.error('Stripe Error:', err);
            Swal.fire('Error', 'Payment processing failed. Please try again.', 'error');
        }
    }

    // Stripe Success Handler
    async function handleStripeSuccess(paymentIntentId) {
        console.log('Processing Stripe success...');
        
        try {
            const response = await fetch('/payment-success-stripe/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({payment_intent_id: paymentIntentId})
            });

            const result = await response.json();

            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Order Placed!',
                    text: `Your order #${result.order_id} has been placed successfully!`,
                    confirmButtonText: 'View Orders'
                }).then(() => {
                    window.location.href = '/order_history/';
                });
            } else {
                Swal.fire('Error', result.error || 'Failed to create order', 'error');
            }
        } catch (err) {
            console.error('Order creation error:', err);
            Swal.fire('Error', 'Failed to create order. Please contact support.', 'error');
        }
    }

    // COD Handler
    function handleCOD() {
        Swal.fire({
            title: 'Confirm Order',
            text: 'You will pay cash when your order is delivered. Continue?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, place order',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = '/payment-success-cod/';
            }
        });
    }

    // Validate address form
    function validateAddressForm() {
        const fields = ['first_name', 'last_name', 'address', 'city', 'country', 'state', 'pincode', 'phone', 'email'];
        const isValid = fields.every(field => {
            const element = document.querySelector(`[name="${field}"]`);
            return element && element.value.trim() !== '';
        });
        
        console.log('Address validation:', isValid);
        return isValid;
    }
</script>

    <style>
        .payment-methods {
            margin: 20px 0;
        }

        .payment-option {
            display: block;
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-option:hover {
            border-color: #0070E0;
            background-color: #f8f9fa;
        }

        .payment-option input[type="radio"] {
            margin-right: 12px;
            cursor: pointer;
        }

        .payment-option input[type="radio"]:checked + .payment-label {
            color: #0070E0;
            font-weight: 600;
        }

        .payment-label {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        .payment-label svg {
            flex-shrink: 0;
        }

        .payment-section {
            margin: 20px 0;
            min-height: 60px;
        }

        #card-element {
            border: 2px solid #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
        }

        #card-errors {
            color: #fa755a;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }

        #paypal-button-container {
            margin-top: 15px;
        }

        .place-order {
            margin-top: 20px;
        }

        .btn-color {
            background-color: #0070E0;
            border: none;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        .btn-color:hover {
            background-color: #005bb5;
        }
    </style>

{% endblock %}